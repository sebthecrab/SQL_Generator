<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SQLite Generator – v05 (Mobile-First, Bootstrap 5.3, sql.js)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root { --maxw: 900px; }
    body { background: #f8fafc; }
    .page { max-width: var(--maxw); margin: 0 auto; padding: 1rem; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .sticky-footer { position: sticky; bottom: 0; background: #fff; border-top: 1px solid #e5e7eb; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body>
  <main class="page">
    <header class="mb-3">
      <h1 class="h4 mb-1">SQLite3 erstellen (v05)</h1>
      <p class="text-muted mb-0">Erzeugt eine SQLite-Datei mit deinen Tabellen (Client-Only, keine Servercalls).</p>
    </header>

    <section class="card mb-3">
      <div class="card-body">
        <div class="d-flex flex-column flex-md-row gap-2 align-items-md-center justify-content-between">
          <div>
            <div class="fw-semibold">Ausgabe</div>
            <div class="text-muted small">Dateiname &amp; optional lokales <span class="code">android_metadata.locale</span></div>
          </div>
          <div class="w-100 w-md-auto d-grid gap-2 gap-md-3" style="grid-template-columns: 1fr; }
">
            <div class="input-group">
              <span class="input-group-text">Datei</span>
              <input id="outName" type="text" class="form-control" value="generated_db.sqlite" />
            </div>
            <div class="input-group">
              <span class="input-group-text">android_metadata.locale</span>
              <input id="androidLocale" type="text" class="form-control" placeholder="z. B. de_DE (optional)" />
            </div>
          </div>
        </div>
        <div class="d-flex flex-wrap gap-2 mt-3">
          <button id="btnBuild" class="btn btn-primary">Datenbank erzeugen</button>
          <button id="btnDownload" class="btn btn-success" disabled>Herunterladen</button>
          <button id="btnShowSchema" class="btn btn-outline-secondary">Schema anzeigen</button>
        </div>
        <div id="status" class="mt-3 small text-muted">Bereit.</div>
      </div>
    </section>

    <section class="card mb-3 d-none" id="schemaCard">
      <div class="card-header d-flex align-items-center justify-content-between">
        <span class="fw-semibold">Erzeugtes Schema (SQL)</span>
        <button id="btnCopySchema" class="btn btn-sm btn-outline-secondary">In Zwischenablage</button>
      </div>
      <div class="card-body">
        <pre class="code mb-0" id="schemaSql"></pre>
      </div>
    </section>

    <section class="card">
      <div class="card-body">
        <h2 class="h6">Was wird erstellt?</h2>
        <ol class="mb-0">
          <li><span class="code">android_metadata</span> mit Spalte <span class="code">locale</span> (optional mit deinem Wert) und einer sichtbaren Primärschlüssel-Spalte <span class="code">__rowid__</span>.</li>
          <li>Alle gewünschten Tabellen mit einer expliziten Spalte <span class="code">"__rowid__ INTEGER PRIMARY KEY"</span>, damit sie in Tools sichtbar ist.</li>
          <li><span class="code">tblCompany</span> erhält die von dir angegebene erste Zeile (Datums-/Zeitwerte wie vorgegeben).</li>
          <li><span class="code">tblSecutestRegistration</span>, <span class="code">tblVisInspectionWeldingHeader</span>, <span class="code">tblVisInspectionWeldingResults</span> werden als leere Tabellen mit <span class="code">__rowid__</span> angelegt (da keine Spalten angegeben).</li>
        </ol>
        <p class="small text-muted mt-2 mb-0">Hinweis: Datentypen sind bewusst generisch (TEXT). Du kannst sie später bei Bedarf verfeinern.</p>
      </div>
    </section>
  </main>

  <div class="sticky-footer">
    <div class="page py-2 d-flex gap-2 align-items-center justify-content-between">
      <span class="small text-muted">Bootstrap 5.3 • sql.js (WASM) • Mobile-First</span>
      <a class="small" href="https://github.com/sql-js/sql.js" target="_blank" rel="noopener">sql.js Projekt</a>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <script>
    // --- State ---
    let SQL = null;
    let db = null;
    let built = false;

    const $ = s => document.querySelector(s);

    (async () => {
      setStatus('Lade SQL-Engine …');
      SQL = await initSqlJs({
        locateFile: file => 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/' + file
      });
      setStatus('Bereit.');
    })();

    $('#btnBuild').addEventListener('click', buildDatabase);
    $('#btnDownload').addEventListener('click', downloadDb);
    $('#btnShowSchema').addEventListener('click', () => {
      const card = $('#schemaCard');
      card.classList.toggle('d-none');
    });
    $('#btnCopySchema').addEventListener('click', async () => {
      const txt = $('#schemaSql').textContent;
      try {
        await navigator.clipboard.writeText(txt);
        setStatus('Schema kopiert.');
      } catch { setStatus('Kopieren nicht möglich (Berechtigung).'); }
    });

    function setStatus(msg) { $('#status').textContent = msg; }

    function buildDatabase() {
      if (!SQL) { setStatus('Engine noch nicht bereit.'); return; }
      if (db) { try { db.close(); } catch {} db = null; }
      db = new SQL.Database();

      // --- Schema (CREATE TABLE) ---
      const schemaStmts = [];

      // Helper to push and run
      function run(sql, params) {
        schemaStmts.push(sql.trim() + (sql.trim().endsWith(';') ? '' : ';'));
        if (params && params.length) {
          const stmt = db.prepare(sql);
          stmt.bind(params);
          while (stmt.step()) {}
          stmt.free();
        } else {
          db.run(sql);
        }
      }

      // 1) android_metadata
      run(`
        CREATE TABLE IF NOT EXISTS "android_metadata" (
          "__rowid__" INTEGER PRIMARY KEY,
          "locale" TEXT
        )
      `);

      const androidLocale = ($('#androidLocale').value || '').trim();
      if (androidLocale) {
        run(`INSERT INTO "android_metadata" ("__rowid__","locale") VALUES (?,?);`, [1, androidLocale]);
      }

      // 2) tblCompany (mit gewünschter erster Zeile)
      run(`
        CREATE TABLE IF NOT EXISTS "tblCompany" (
          "__rowid__" INTEGER PRIMARY KEY,
          "SecutestSerialNumber" TEXT,
          "KeyCode1" TEXT,
          "RegistrationDate1" TEXT,
          "CustomerNumber" TEXT,
          "Company" TEXT,
          "Department" TEXT,
          "Name" TEXT,
          "Street" TEXT,
          "PostalCode" TEXT,
          "City" TEXT,
          "TelephoneNumber" TEXT,
          "FaxNumber" TEXT,
          "Email" TEXT,
          "Country" TEXT,
          "Supplier" TEXT,
          "ArchiveDate" TEXT,
          "ArchiveInterval" TEXT,
          "Timestamp" TEXT
        )
      `);

      // Eintrag gemäß Vorgabe
      run(`
        INSERT INTO "tblCompany" (
          "__rowid__", "SecutestSerialNumber","KeyCode1","RegistrationDate1","CustomerNumber","Company",
          "Department","Name","Street","PostalCode","City","TelephoneNumber","FaxNumber","Email","Country",
          "Supplier","ArchiveDate","ArchiveInterval","Timestamp"
        ) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)
      `, [
        1,
        null, // SecutestSerialNumber
        null, // KeyCode1
        "2021-09-13 14:46:04",
        null, // CustomerNumber
        "E+Service+Check GmbH",
        null, // Department
        null, // Name
        "Große Ziegelohstraße 2",
        "06636",
        "Laucha (Unstrut)",
        null, // TelephoneNumber
        null, // FaxNumber
        null, // Email
        "DE - Deutschland",
        null, // Supplier
        "2021-09-13 14:46:04",
        "12",
        "2021-09-13 12:46:04"
      ]);

      // 3) tblCustomer
      run(`
        CREATE TABLE IF NOT EXISTS "tblCustomer" (
          "__rowid__" INTEGER PRIMARY KEY,
          "CustomerNumber1" TEXT, "Name" TEXT, "Contact" TEXT, "Street" TEXT, "ZIP" TEXT, "City" TEXT,
          "Country" TEXT, "Tel" TEXT, "Fax" TEXT, "Email" TEXT, "Remark" TEXT, "Timestamp" TEXT, "ArchiveDate" TEXT
        )
      `);

      // 4) tblDeviceAbbreviations
      run(`
        CREATE TABLE IF NOT EXISTS "tblDeviceAbbreviations" (
          "__rowid__" INTEGER PRIMARY KEY,
          "DeviceAbbreviation" TEXT, "DeviceDescription1" TEXT, "Timestamp" TEXT
        )
      `);

      // 5) tblIDNumberCaptions
      run(`
        CREATE TABLE IF NOT EXISTS "tblIDNumberCaptions" (
          "__rowid__" INTEGER PRIMARY KEY,
          "Name" TEXT, "Order" TEXT, "NewOrder" TEXT, "ColumnNo" TEXT, "NewCaption1" TEXT, "Hide" TEXT,
          "ProtocolNumber" TEXT, "Mandatory" TEXT, "Export" TEXT, "TimeStamp" TEXT
        )
      `);

      // 6) tblIDNumbers
      run(`
        CREATE TABLE IF NOT EXISTS "tblIDNumbers" (
          "__rowid__" INTEGER PRIMARY KEY,
          "ProcedureName" TEXT, "CustomerNumber" TEXT, "IDNumber" TEXT, "Location" TEXT, "DeviceDescription" TEXT,
          "Manufacturer" TEXT, "Type" TEXT, "Class" TEXT, "Standard" TEXT, "SubStandard" TEXT, "FactoryNumber" TEXT,
          "User1" TEXT, "User2" TEXT, "User3" TEXT, "Remark" TEXT, "TestInterval" TEXT, "ProtocolForm" TEXT,
          "CableLength" TEXT, "CableCrossection" TEXT, "HeatingPower" TEXT, "Power" TEXT, "OCVoltage" TEXT,
          "AppliedParts" TEXT, "RCDType" TEXT, "RCDIDN" TEXT, "IsolatedParts" TEXT, "PEParts" TEXT, "PETest" TEXT,
          "InsulationTest1" TEXT, "CurrentClamp" TEXT, "PRCDS" TEXT, "ELV" TEXT, "ELVTest" TEXT, "SurgeArrestor" TEXT,
          "Wiring" TEXT, "Pictures" TEXT, "LastTest" TEXT, "TestResult" TEXT, "NextTest" TEXT, "Hyperlink" TEXT,
          "Status" TEXT, "Remark2" TEXT, "TestNumber" TEXT, "Timestamp" TEXT
        )
      `);

      // 7) tblMasterProcedureCopy (ohne __rowid__ gefordert? – wir fügen es konsistent hinzu)
      run(`
        CREATE TABLE IF NOT EXISTS "tblMasterProcedureCopy" (
          "__rowid__" INTEGER PRIMARY KEY,
          "Parameter1" TEXT, "Parameter2" TEXT, "Parameter3" TEXT, "Parameter4" TEXT,
          "Min" TEXT, "Max" TEXT, "First" TEXT, "Expected" TEXT, "Unit" TEXT,
          "RangeMin" TEXT, "RangeMax" TEXT,
          "TypeParameter1" TEXT, "TypeParameter2" TEXT, "TypeParameter3" TEXT, "TypeParameter4" TEXT,
          "WorstCaseCondition" TEXT, "Simulation" TEXT, "WebServer" TEXT
        )
      `);

      // 8) tblResults
      run(`
        CREATE TABLE IF NOT EXISTS "tblResults" (
          "__rowid__" INTEGER PRIMARY KEY,
          "ProcedureName" TEXT, "CustomerNumber" TEXT, "IDNumber" TEXT, "TestNumber" TEXT, "ResultNumber" TEXT,
          "ProcedureStepNumber1" TEXT, "FunctionName" TEXT, "Picture" TEXT, "Remark" TEXT, "Protocol" TEXT,
          "WorstCase" TEXT, "TestTime" TEXT,
          "Parameter1" TEXT, "Parameter2" TEXT, "Parameter3" TEXT, "Parameter4" TEXT,
          "Min" TEXT, "Max" TEXT, "First" TEXT, "Expected" TEXT, "Result" TEXT, "OK" TEXT
        )
      `);

      // 9) tblResultsHeader
      run(`
        CREATE TABLE IF NOT EXISTS "tblResultsHeader" (
          "__rowid__" INTEGER PRIMARY KEY,
          "ProcedureName" TEXT, "CustomerNumber" TEXT, "IDNumber" TEXT, "TestNumber" TEXT, "OrderNumber" TEXT,
          "Remark" TEXT, "TestDate" TEXT, "TestResult" TEXT, "TestingPerson" TEXT, "Pictures" TEXT,
          "SecutestIDString" TEXT, "SoftwareVersion" TEXT, "SecutestSoftwareVersion" TEXT, "TesterSerialNumber" TEXT,
          "LineVoltage" TEXT, "Protocol" TEXT, "Timestamp" TEXT
        )
      `);

      // 10) tblSecutestRegistration (keine Spalten vorgegeben -> minimal mit __rowid__)
      run(`
        CREATE TABLE IF NOT EXISTS "tblSecutestRegistration" (
          "__rowid__" INTEGER PRIMARY KEY
        )
      `);

      // 11) tblVisInspectionWeldingHeader (keine Spalten vorgegeben -> minimal)
      run(`
        CREATE TABLE IF NOT EXISTS "tblVisInspectionWeldingHeader" (
          "__rowid__" INTEGER PRIMARY KEY
        )
      `);

      // 12) tblVisInspectionWeldingResults (keine Spalten vorgegeben -> minimal)
      run(`
        CREATE TABLE IF NOT EXISTS "tblVisInspectionWeldingResults" (
          "__rowid__" INTEGER PRIMARY KEY
        )
      `);

      built = true;
      $('#btnDownload').disabled = false;
      setStatus('Datenbank im Speicher erstellt. Du kannst sie jetzt herunterladen.');

      // Schema anzeigen
      $('#schemaSql').textContent = schemaStmts.join('\n');
      $('#schemaCard').classList.remove('d-none');
    }

    function downloadDb() {
      if (!db || !built) { setStatus('Bitte zuerst erzeugen.'); return; }
      const outName = ($('#outName').value || 'generated_db.sqlite').trim();
      const bin = db.export();
      const blob = new Blob([bin], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = outName;
      a.click();
      URL.revokeObjectURL(url);
      setStatus('Download gestartet: ' + outName);
    }
  </script>
</body>
</html>
