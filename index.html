<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SQLite-Exporter (Schema + Seed) – Mobile First</title>

  <!-- Bootstrap (aktuelle 5.x via jsDelivr) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Mobile-first Tweaks */
    body{background:#f8fafc}
    .card{border-radius:1rem}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .small-mono{font-size:.9rem}
  </style>
</head>
<body>
  <main class="container py-4">
    <div class="row g-3">
      <div class="col-12 col-lg-7">
        <div class="card shadow-sm">
          <div class="card-body">
            <h1 class="h4 mb-3">SQLite3 erstellen &amp; exportieren</h1>
            <p class="text-muted mb-4">
              Diese Seite erzeugt lokal im Browser (per <span class="mono">sql.js</span>) eine <strong>SQLite3</strong>-Datei
              mit deinem Schema &amp; Startdaten. Nichts verlässt dein Gerät.
            </p>

            <div class="mb-3">
              <label class="form-label">„Jetzt“-Zeitstempel (Europa/Berlin)</label>
              <input id="nowPreview" class="form-control mono" type="text" value="" readonly>
              <div class="form-text">Format: JJJJ-MM-DD HH:MM:SS – wird in <span class="mono">tblCustomer.Timestamp</span> und <span class="mono">tblCustomer.ArchiveDate</span> geschrieben.</div>
            </div>

            <div class="d-grid d-sm-flex gap-2">
              <button id="btnBuild" class="btn btn-primary btn-lg">SQLite exportieren</button>
              <a id="downloadLink" class="btn btn-outline-secondary btn-lg disabled" download>Download ist bereit</a>
            </div>

            <div id="alertBox" class="mt-3"></div>

            <hr class="my-4">

            <details>
              <summary class="mb-2"><strong>Inhalt &amp; Seed-Daten (Kurzfassung)</strong></summary>
              <ul class="small">
                <li><span class="mono">android_metadata(locale)</span> (leer)</li>
                <li><span class="mono">tblCompany</span>: eine Zeile mit <span class="mono">Company = "E+Service+Check GmbH"</span>, Adressdaten und festen Zeitstempeln 2021</li>
                <li><span class="mono">tblCustomer</span>: eine Zeile mit <span class="mono">CustomerNumber1 = 666</span>, <span class="mono">Name = "Max Muster Corp"</span>, <span class="mono">Timestamp</span> = <em>Jetzt</em></li>
                <li>Weitere Tabellen werden gemäß Vorgabe angelegt (leer)</li>
              </ul>
            </details>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-5">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h5">Schema (Übersicht)</h2>
            <pre class="small-mono mb-0" style="white-space:pre-wrap" id="schemaPreview"></pre>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Bootstrap JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- sql.js (SQLite im Browser) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <script>
    // ----- Helfer -----
    const $ = sel => document.querySelector(sel);

    // Format "JJJJ-MM-DD HH:MM:SS" in Europe/Berlin
    function nowBerlin() {
      try {
        const tz = 'Europe/Berlin';
        const d = new Date();
        // Komponenten im Ziel-TZ erzeugen
        const parts = new Intl.DateTimeFormat('de-DE', {
          timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit',
          hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
        }).formatToParts(d).reduce((acc,p)=>{acc[p.type]=p.value; return acc;}, {});
        // de-DE liefert TT.MM.JJJJ — wir wollen JJJJ-MM-DD HH:MM:SS
        const DD = parts.day, MM = parts.month, YYYY = parts.year;
        const HH = parts.hour, MIN = parts.minute, SS = parts.second;
        return `${YYYY}-${MM}-${DD} ${HH}:${MIN}:${SS}`;
      } catch {
        // Fallback: lokale Zeit ohne TZ-Konversion
        const pad = n => String(n).padStart(2,'0');
        const d = new Date();
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      }
    }

    // Zeige "Jetzt" sofort
    function updateNowPreview(){
      $('#nowPreview').value = nowBerlin();
    }
    updateNowPreview();
    setInterval(updateNowPreview, 1000);

    // ----- Schema (CREATE TABLES) -----
    // Hinweis: __rowid__ ist ein spezielles SQLite-RowID-Alias und wird NICHT als Spalte angelegt.
    const schemaSQL = `
CREATE TABLE IF NOT EXISTS android_metadata (
  locale TEXT
);

CREATE TABLE IF NOT EXISTS tblCompany (
  SecutestSerialNumber   TEXT,
  KeyCode1               TEXT,
  RegistrationDate1      TEXT,
  CustomerNumber         TEXT,
  Company                TEXT,
  Department             TEXT,
  Name                   TEXT,
  Street                 TEXT,
  PostalCode             TEXT,
  City                   TEXT,
  TelephoneNumber        TEXT,
  FaxNumber              TEXT,
  Email                  TEXT,
  Country                TEXT,
  Supplier               TEXT,
  ArchiveDate            TEXT,
  ArchiveInterval        INTEGER,
  Timestamp              TEXT
);

CREATE TABLE IF NOT EXISTS tblCustomer (
  CustomerNumber1  TEXT,
  Name             TEXT,
  Contact          TEXT,
  Street           TEXT,
  ZIP              TEXT,
  City             TEXT,
  Country          TEXT,
  Tel              TEXT,
  Fax              TEXT,
  Email            TEXT,
  Remark           TEXT,
  Timestamp        TEXT,
  ArchiveDate      TEXT,
  ArchiveInterval  INTEGER
);

CREATE TABLE IF NOT EXISTS tblDeviceAbbreviations (
  DeviceAbbreviation  TEXT,
  DeviceDescription1  TEXT,
  Timestamp           TEXT
);

CREATE TABLE IF NOT EXISTS tblIDNumberCaptions (
  Name            TEXT,
  "Order"         INTEGER,
  NewOrder        INTEGER,
  ColumnNo        INTEGER,
  NewCaption1     TEXT,
  Hide            INTEGER,
  ProtocolNumber  TEXT,
  Mandatory       INTEGER,
  Export          INTEGER,
  TimeStamp       TEXT
);

CREATE TABLE IF NOT EXISTS tblIDNumbers (
  ProcedureName    TEXT,
  CustomerNumber   TEXT,
  IDNumber         TEXT,
  Location         TEXT,
  DeviceDescription TEXT,
  Manufacturer     TEXT,
  Type             TEXT,
  Class            TEXT,
  Standard         TEXT,
  SubStandard      TEXT,
  FactoryNumber    TEXT,
  User1            TEXT,
  User2            TEXT,
  User3            TEXT,
  Remark           TEXT,
  TestInterval     TEXT,
  ProtocolForm     TEXT,
  CableLength      TEXT,
  CableCrossection TEXT,
  HeatingPower     TEXT,
  Power            TEXT,
  OCVoltage        TEXT,
  AppliedParts     TEXT,
  RCDType          TEXT,
  RCDIDN           TEXT,
  IsolatedParts    TEXT,
  PEParts          TEXT,
  PETest           TEXT,
  InsulationTest1  TEXT,
  CurrentClamp     TEXT,
  PRCDS            TEXT,
  ELV              TEXT,
  ELVTest          TEXT,
  SurgeArrestor    TEXT,
  Wiring           TEXT,
  Pictures         TEXT,
  LastTest         TEXT,
  TestResult       TEXT,
  NextTest         TEXT,
  Hyperlink        TEXT,
  Status           TEXT,
  Remark2          TEXT,
  TestNumber       TEXT,
  Timestamp        TEXT
);

CREATE TABLE IF NOT EXISTS tblMasterProcedureCopy (
  Parameter1          TEXT,
  Parameter2          TEXT,
  Parameter3          TEXT,
  Parameter4          TEXT,
  Min                 TEXT,
  Max                 TEXT,
  First               TEXT,
  Expected            TEXT,
  Unit                TEXT,
  RangeMin            TEXT,
  RangeMax            TEXT,
  TypeParameter1      TEXT,
  TypeParameter2      TEXT,
  TypeParameter3      TEXT,
  TypeParameter4      TEXT,
  WorstCaseCondition  TEXT,
  Simulation          TEXT,
  WebServer           TEXT
);

CREATE TABLE IF NOT EXISTS tblResults (
  ProcedureName        TEXT,
  CustomerNumber       TEXT,
  IDNumber             TEXT,
  TestNumber           TEXT,
  ResultNumber         TEXT,
  ProcedureStepNumber1 TEXT,
  FunctionName         TEXT,
  Picture              TEXT,
  Remark               TEXT,
  Protocol             TEXT,
  WorstCase            TEXT,
  TestTime             TEXT,
  Parameter1           TEXT,
  Parameter2           TEXT,
  Parameter3           TEXT,
  Parameter4           TEXT,
  Min                  TEXT,
  Max                  TEXT,
  First                TEXT,
  Expected             TEXT,
  Result               TEXT,
  OK                   TEXT
);

CREATE TABLE IF NOT EXISTS tblResultsHeader (
  ProcedureName         TEXT,
  CustomerNumber        TEXT,
  IDNumber              TEXT,
  TestNumber            TEXT,
  OrderNumber           TEXT,
  Remark                TEXT,
  TestDate              TEXT,
  TestResult            TEXT,
  TestingPerson         TEXT,
  Pictures              TEXT,
  SecutestIDString      TEXT,
  SoftwareVersion       TEXT,
  SecutestSoftwareVersion TEXT,
  TesterSerialNumber    TEXT,
  LineVoltage           TEXT,
  Protocol              TEXT,
  Timestamp             TEXT
);

CREATE TABLE IF NOT EXISTS tblSecutestRegistration (
  -- Felder nicht spezifiziert: Tabelle wird leer angelegt
  dummy TEXT
);

CREATE TABLE IF NOT EXISTS tblVisInspectionWeldingHeader (
  dummy TEXT
);

CREATE TABLE IF NOT EXISTS tblVisInspectionWeldingResults (
  dummy TEXT
);
`.trim();

    $('#schemaPreview').textContent = schemaSQL;

    // ----- DB bauen & exportieren -----
    let SQL; // sql.js Modul

    (async function initSql(){
      SQL = await initSqlJs({
        locateFile: file => 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/' + file
      });
    })();

    function showAlert(html, type='info'){
      $('#alertBox').innerHTML = `<div class="alert alert-${type} mb-0" role="alert">${html}</div>`;
    }

    async function buildAndExport(){
      if(!SQL){ showAlert('SQL-Engine lädt noch. Bitte erneut versuchen …','warning'); return; }

      const now = nowBerlin(); // "Jetzt"
      const db = new SQL.Database();

      try{
        // Schema ausführen
        db.run('BEGIN;');
        db.run(schemaSQL);

        // Optionale Standardzeile für android_metadata (falls gewünscht – nicht gefordert):
        // db.run(`INSERT INTO android_metadata(locale) VALUES ('de_DE');`);

        // tblCompany – Zeile 1
        {
          const sql = `
            INSERT INTO tblCompany (
              SecutestSerialNumber, KeyCode1, RegistrationDate1, CustomerNumber, Company, Department, Name, Street, PostalCode, City,
              TelephoneNumber, FaxNumber, Email, Country, Supplier, ArchiveDate, ArchiveInterval, Timestamp
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
          `;
          const params = [
            null, // SecutestSerialNumber
            null, // KeyCode1
            '2021-09-13 14:46:04', // RegistrationDate1
            null, // CustomerNumber
            'E+Service+Check GmbH', // Company
            null, // Department
            null, // Name
            'Große Ziegelohstraße 2', // Street
            '06636', // PostalCode
            'Laucha (Unstrut)', // City
            null, // TelephoneNumber
            null, // FaxNumber
            null, // Email
            'DE - Deutschland', // Country
            null, // Supplier
            '2021-09-13 14:46:04', // ArchiveDate
            12,   // ArchiveInterval
            '2021-09-13 12:46:04'  // Timestamp
          ];
          const stmt = db.prepare(sql);
          stmt.bind(params); stmt.step(); stmt.free();
          // RowID wird automatisch 1 (erste Zeile)
        }

        // tblCustomer – Zeile 1 (mit "Jetzt")
        {
          const sql = `
            INSERT INTO tblCustomer (
              CustomerNumber1, Name, Contact, Street, ZIP, City, Country, Tel, Fax, Email, Remark, Timestamp, ArchiveDate, ArchiveInterval
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
          `;
          const params = [
            '666',
            'Max Muster Corp',
            'Max Muster',
            'Musterstraße 3',
            '666',
            'Musterstadt',
            'DE - Deutschland',
            null, null, null, // Tel, Fax, Email
            null,             // Remark
            now,              // Timestamp (Jetzt)
            now,              // ArchiveDate (Jetzt)
            12                // ArchiveInterval
          ];
          const stmt = db.prepare(sql);
          stmt.bind(params); stmt.step(); stmt.free();
        }

        db.run('COMMIT;');

        // Export
        const binaryArray = db.export(); // Uint8Array
        const blob = new Blob([binaryArray], { type: 'application/octet-stream' });

        // Download-Link aktivieren
        const url = URL.createObjectURL(blob);
        const ts = now.replace(/[: ]/g,'-'); // für Dateinamen
        const filename = `export_${ts}.sqlite`;
        const a = $('#downloadLink');
        a.href = url;
        a.download = filename;
        a.classList.remove('disabled');

        showAlert(`Fertig! <strong>${filename}</strong> ist bereit zum Download.`, 'success');
      } catch(e){
        try{ db.run('ROLLBACK;'); }catch(_){}
        console.error(e);
        showAlert(`Fehler beim Erstellen: <code class="mono">${(e && e.message) ? e.message : e}</code>`, 'danger');
      } finally {
        // db.close() nicht nötig solange Blob/URL lebt; wir lassen offen bis Download.
      }
    }

    $('#btnBuild').addEventListener('click', buildAndExport);
  </script>
</body>
</html>
