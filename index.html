<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SQLite3-Exporter – Mobile First (Bootstrap + sql.js)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --maxw: 980px; }
    body { background: #f8fafc; }
    .container-narrow { max-width: var(--maxw); }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .card { border-radius: 1rem; }
    .small-muted { color:#6b7280; font-size:.9rem; }
    .req::after { content:" *"; color:#dc3545; }
    .sticky-footer { position:sticky; bottom:0; z-index:5; background:#fff; border-top:1px solid #e5e7eb; }
  </style>
</head>
<body>
  <header class="bg-white border-bottom">
    <div class="container container-narrow py-3 d-flex align-items-center justify-content-between">
      <h1 class="h5 mb-0">SQLite3-Exporter (Client-only)</h1>
      <span class="badge text-bg-light">Bootstrap 5 · sql.js (WASM)</span>
    </div>
  </header>

  <main class="container container-narrow my-4">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h2 class="h6">Allgemeine Einstellungen</h2>
        <div class="row g-3">
          <div class="col-12 col-sm-6">
            <label class="form-label req">Dateiname (ohne Endung)</label>
            <input id="dbName" class="form-control" placeholder="my_database" value="export" />
            <div class="form-text">Die Datei wird als <span class="code">.sqlite3</span> heruntergeladen.</div>
          </div>
          <div class="col-12 col-sm-6">
            <label class="form-label req">android_metadata.locale</label>
            <input id="locale" class="form-control" placeholder="de_DE" value="de_DE" />
            <div class="form-text">Wird in <span class="code">android_metadata(locale)</span> eingetragen.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h2 class="h6">tblCompany – Erster Datensatz</h2>
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">SecutestSerialNumber</label>
            <input id="company_SecutestSerialNumber" class="form-control" />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">KeyCode1</label>
            <input id="company_KeyCode1" class="form-control" />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">RegistrationDate1</label>
            <input id="company_RegistrationDate1" class="form-control" value="2021-09-13 14:46:04" />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">CustomerNumber</label>
            <input id="company_CustomerNumber" class="form-control" />
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label req">Company</label>
            <input id="company_Company" class="form-control" value="E+Service+Check GmbH" />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Department</label>
            <input id="company_Department" class="form-control" />
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">Name</label>
            <input id="company_Name" class="form-control" />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Street</label>
            <input id="company_Street" class="form-control" value="Große Ziegelohstraße 2" />
          </div>

          <div class="col-6 col-md-3">
            <label class="form-label">PostalCode</label>
            <input id="company_PostalCode" class="form-control" value="06636" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">City</label>
            <input id="company_City" class="form-control" value="Laucha (Unstrut)" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">TelephoneNumber</label>
            <input id="company_TelephoneNumber" class="form-control" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">FaxNumber</label>
            <input id="company_FaxNumber" class="form-control" />
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">Email</label>
            <input id="company_Email" class="form-control" />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Country</label>
            <input id="company_Country" class="form-control" value="DE - Deutschland" />
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">Supplier</label>
            <input id="company_Supplier" class="form-control" />
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">ArchiveDate</label>
            <input id="company_ArchiveDate" class="form-control" value="2021-09-13 14:46:04" />
          </div>

          <div class="col-6 col-md-3">
            <label class="form-label">ArchiveInterval</label>
            <input id="company_ArchiveInterval" class="form-control" value="12" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Timestamp</label>
            <input id="company_Timestamp" class="form-control" value="2021-09-13 12:46:04" />
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h2 class="h6">Tabellenübersicht (Schema, ohne Datentyp-Zwänge)</h2>
        <p class="small-muted mb-2">
          Es werden alle von dir genannten Tabellen angelegt. Für Felder nutze ich standardmäßig
          <span class="code">TEXT</span> (kompatibel & flexibel); du kannst später bei Bedarf Typen verengen.
        </p>
        <ul class="small">
          <li><span class="code">android_metadata(locale)</span> (mit Eintrag)</li>
          <li><span class="code">tblCompany</span> (mit deinem ersten Datensatz)</li>
          <li><span class="code">tblCustomer, tblDeviceAbbreviations, tblIDNumberCaptions, tblIDNumbers, tblMasterProcedureCopy, tblResults, tblResultsHeader</span> (leer)</li>
          <li><span class="code">tblSecutestRegistration, tblVisInspectionWeldingHeader, tblVisInspectionWeldingResults</span> – da keine Spalten angegeben waren, lege ich jeweils
            <span class="code">id INTEGER PRIMARY KEY, data TEXT</span> an (neutral & erweiterbar).
          </li>
        </ul>
      </div>
    </div>

    <div class="d-grid gap-2">
      <button id="btnMake" class="btn btn-primary btn-lg">SQLite erstellen & herunterladen</button>
      <div id="msg" class="mt-2 small"></div>
    </div>
  </main>

  <footer class="sticky-footer py-2">
    <div class="container container-narrow d-flex justify-content-between align-items-center">
      <span class="small-muted">Alles passiert lokal in deinem Browser.</span>
      <a class="small" href="https://github.com/sql-js/sql.js" target="_blank" rel="noopener">sql.js Projekt</a>
    </div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <script>
    const $ = (s) => document.querySelector(s);

    let SQL = null;

    (async function init() {
      SQL = await initSqlJs({
        locateFile: file => 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/' + file
      });
    })();

    function msg(html, type='secondary') {
      $('#msg').innerHTML = '<div class="alert alert-' + type + ' mb-0">' + html + '</div>';
    }

    // --- Schema (CREATE TABLE) ---
    // Alle Spalten als TEXT, falls nicht anders vorgegeben. Primärschlüssel / Indizes kannst du später ergänzen.
    const schemaSQL = `
CREATE TABLE IF NOT EXISTS android_metadata (
  locale TEXT
);

CREATE TABLE IF NOT EXISTS tblCompany (
  SecutestSerialNumber TEXT,
  KeyCode1 TEXT,
  RegistrationDate1 TEXT,
  CustomerNumber TEXT,
  Company TEXT,
  Department TEXT,
  Name TEXT,
  Street TEXT,
  PostalCode TEXT,
  City TEXT,
  TelephoneNumber TEXT,
  FaxNumber TEXT,
  Email TEXT,
  Country TEXT,
  Supplier TEXT,
  ArchiveDate TEXT,
  ArchiveInterval TEXT,
  Timestamp TEXT
);

CREATE TABLE IF NOT EXISTS tblCustomer (
  CustomerNumber1 TEXT,
  Name TEXT,
  Contact TEXT,
  Street TEXT,
  ZIP TEXT,
  City TEXT,
  Country TEXT,
  Tel TEXT,
  Fax TEXT,
  Email TEXT,
  Remark TEXT,
  Timestamp TEXT,
  ArchiveDate TEXT
);

CREATE TABLE IF NOT EXISTS tblDeviceAbbreviations (
  DeviceAbbreviation TEXT,
  DeviceDescription1 TEXT,
  Timestamp TEXT
);

CREATE TABLE IF NOT EXISTS tblIDNumberCaptions (
  Name TEXT,
  "Order" TEXT,
  NewOrder TEXT,
  ColumnNo TEXT,
  NewCaption1 TEXT,
  Hide TEXT,
  ProtocolNumber TEXT,
  Mandatory TEXT,
  Export TEXT,
  TimeStamp TEXT
);

CREATE TABLE IF NOT EXISTS tblIDNumbers (
  ProcedureName TEXT,
  CustomerNumber TEXT,
  IDNumber TEXT,
  Location TEXT,
  DeviceDescription TEXT,
  Manufacturer TEXT,
  Type TEXT,
  Class TEXT,
  Standard TEXT,
  SubStandard TEXT,
  FactoryNumber TEXT,
  User1 TEXT,
  User2 TEXT,
  User3 TEXT,
  Remark TEXT,
  TestInterval TEXT,
  ProtocolForm TEXT,
  CableLength TEXT,
  CableCrossection TEXT,
  HeatingPower TEXT,
  Power TEXT,
  OCVoltage TEXT,
  AppliedParts TEXT,
  RCDType TEXT,
  RCDIDN TEXT,
  IsolatedParts TEXT,
  PEParts TEXT,
  PETest TEXT,
  InsulationTest1 TEXT,
  CurrentClamp TEXT,
  PRCDS TEXT,
  ELV TEXT,
  ELVTest TEXT,
  SurgeArrestor TEXT,
  Wiring TEXT,
  Pictures TEXT,
  LastTest TEXT,
  TestResult TEXT,
  NextTest TEXT,
  Hyperlink TEXT,
  Status TEXT,
  Remark2 TEXT,
  TestNumber TEXT,
  Timestamp TEXT
);

CREATE TABLE IF NOT EXISTS tblMasterProcedureCopy (
  Parameter1 TEXT,
  Parameter2 TEXT,
  Parameter3 TEXT,
  Parameter4 TEXT,
  Min TEXT,
  Max TEXT,
  First TEXT,
  Expected TEXT,
  Unit TEXT,
  RangeMin TEXT,
  RangeMax TEXT,
  TypeParameter1 TEXT,
  TypeParameter2 TEXT,
  TypeParameter3 TEXT,
  TypeParameter4 TEXT,
  WorstCaseCondition TEXT,
  Simulation TEXT,
  WebServer TEXT
);

CREATE TABLE IF NOT EXISTS tblResults (
  ProcedureName TEXT,
  CustomerNumber TEXT,
  IDNumber TEXT,
  TestNumber TEXT,
  ResultNumber TEXT,
  ProcedureStepNumber1 TEXT,
  FunctionName TEXT,
  Picture TEXT,
  Remark TEXT,
  Protocol TEXT,
  WorstCase TEXT,
  TestTime TEXT,
  Parameter1 TEXT,
  Parameter2 TEXT,
  Parameter3 TEXT,
  Parameter4 TEXT,
  Min TEXT,
  Max TEXT,
  First TEXT,
  Expected TEXT,
  Result TEXT,
  OK TEXT
);

CREATE TABLE IF NOT EXISTS tblResultsHeader (
  ProcedureName TEXT,
  CustomerNumber TEXT,
  IDNumber TEXT,
  TestNumber TEXT,
  OrderNumber TEXT,
  Remark TEXT,
  TestDate TEXT,
  TestResult TEXT,
  TestingPerson TEXT,
  Pictures TEXT,
  SecutestIDString TEXT,
  SoftwareVersion TEXT,
  SecutestSoftwareVersion TEXT,
  TesterSerialNumber TEXT,
  LineVoltage TEXT,
  Protocol TEXT,
  Timestamp TEXT
);

/* Für die drei Tabellen ohne definierte Spalten lege ich neutrale Felder an:
   - id: künstlicher PK (optional nutzbar)
   - data: JSON/Text-Payload für flexible Inhalte
   Das ist die sicherste Option, solange das Zielschema unbekannt ist. */
CREATE TABLE IF NOT EXISTS tblSecutestRegistration (
  id INTEGER PRIMARY KEY,
  data TEXT
);
CREATE TABLE IF NOT EXISTS tblVisInspectionWeldingHeader (
  id INTEGER PRIMARY KEY,
  data TEXT
);
CREATE TABLE IF NOT EXISTS tblVisInspectionWeldingResults (
  id INTEGER PRIMARY KEY,
  data TEXT
);
`.trim();

    // Erst-Datensatz für tblCompany aus den Formularfeldern
    function companyRowFromForm() {
      const get = id => $(id).value || null;
      return {
        SecutestSerialNumber: get('#company_SecutestSerialNumber'),
        KeyCode1:              get('#company_KeyCode1'),
        RegistrationDate1:     get('#company_RegistrationDate1'),
        CustomerNumber:        get('#company_CustomerNumber'),
        Company:               get('#company_Company'),
        Department:            get('#company_Department'),
        Name:                  get('#company_Name'),
        Street:                get('#company_Street'),
        PostalCode:            get('#company_PostalCode'),
        City:                  get('#company_City'),
        TelephoneNumber:       get('#company_TelephoneNumber'),
        FaxNumber:             get('#company_FaxNumber'),
        Email:                 get('#company_Email'),
        Country:               get('#company_Country'),
        Supplier:              get('#company_Supplier'),
        ArchiveDate:           get('#company_ArchiveDate'),
        ArchiveInterval:       get('#company_ArchiveInterval'),
        Timestamp:             get('#company_Timestamp')
      };
    }

    async function makeAndDownload() {
      try {
        msg('Erzeuge Datenbank …', 'info');

        const db = new SQL.Database();

        // Schema anlegen
        db.run(schemaSQL);

        // android_metadata einfügen
        const locale = ($('#locale').value || 'de_DE').trim();
        db.run('DELETE FROM android_metadata;'); // idempotent
        const stmtMeta = db.prepare('INSERT INTO android_metadata(locale) VALUES (?);');
        stmtMeta.bind([locale]); stmtMeta.step(); stmtMeta.free();

        // Erster Datensatz tblCompany
        const row = companyRowFromForm();
        const cols = Object.keys(row);
        const vals = cols.map(c => row[c]);
        const placeholders = cols.map(_=>'?').join(', ');
        const sqlIns = `INSERT INTO tblCompany(${cols.map(c => '"'+c+'"').join(', ')}) VALUES (${placeholders});`;
        const stmtComp = db.prepare(sqlIns);
        stmtComp.bind(vals); stmtComp.step(); stmtComp.free();

        // Export
        const bin = db.export();
        const blob = new Blob([bin], { type: 'application/octet-stream' });
        const a = document.createElement('a');
        const name = ($('#dbName').value || 'export').replace(/[^a-z0-9_\-]+/gi,'_');
        a.href = URL.createObjectURL(blob);
        a.download = name + '.sqlite3';
        a.click();
        URL.revokeObjectURL(a.href);

        msg('Fertig! Die Datei wurde heruntergeladen.', 'success');
      } catch (e) {
        console.error(e);
        msg('Fehler: ' + (e?.message || e), 'danger');
      }
    }

    $('#btnMake').addEventListener('click', makeAndDownload);
  </script>
</body>
</html>
