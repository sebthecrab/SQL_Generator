<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SQLite-Exporter (Schema + Seed) – Mobile First</title>

  <!-- Bootstrap (aktuelle 5.x via jsDelivr) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Mobile-first Tweaks */
    body{background:#f8fafc}
    .card{border-radius:1rem}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .small-mono{font-size:.9rem}
  </style>
</head>
<body>
  <main class="container py-4">
    <div class="row g-3">
      <div class="col-12 col-lg-7">
        <div class="card shadow-sm">
          <div class="card-body">
            <h1 class="h4 mb-3">SQLite3 erstellen &amp; exportieren - V2.3</h1>
            <p class="text-muted mb-4">
              Diese Seite erzeugt lokal im Browser (per <span class="mono">sql.js</span>) eine <strong>SQLite3</strong>-Datei
              mit deinem Schema &amp; Startdaten. Nichts verlässt dein Gerät.
            </p>

            <div class="mb-3">
              <label class="form-label">„Jetzt“-Zeitstempel (Europa/Berlin)</label>
              <input id="nowPreview" class="form-control mono" type="text" value="" readonly>
              <div class="form-text">Format: JJJJ-MM-DD HH:MM:SS – wird in <span class="mono">tblCustomer.Timestamp</span> und <span class="mono">tblCustomer.ArchiveDate</span> geschrieben.</div>
            </div>

            <div class="d-grid d-sm-flex gap-2">
              <button id="btnBuild" class="btn btn-primary btn-lg">SQLite exportieren</button>
              <a id="downloadLink" class="btn btn-outline-secondary btn-lg disabled" download>Download ist bereit</a>
            </div>

            <div id="alertBox" class="mt-3"></div>

            <hr class="my-4">

            <details>
              <summary class="mb-2"><strong>Inhalt &amp; Seed-Daten (Kurzfassung)</strong></summary>
              <ul class="small">
                <li><span class="mono">android_metadata(locale)</span> (leer)</li>
                <li><span class="mono">tblCompany</span>: eine Zeile mit <span class="mono">Company = "E+Service+Check GmbH"</span>, Adressdaten und festen Zeitstempeln 2021</li>
                <li><span class="mono">tblCustomer</span>: eine Zeile mit <span class="mono">CustomerNumber1 = 666</span>, <span class="mono">Name = "Max Muster Corp"</span>, <span class="mono">Timestamp</span> = <em>Jetzt</em></li>
                <li>Weitere Tabellen werden gemäß Vorgabe angelegt (leer)</li>
              </ul>
            </details>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-5">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h5">Schema (Übersicht)</h2>
            <pre class="small-mono mb-0" style="white-space:pre-wrap" id="schemaPreview"></pre>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Bootstrap JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- sql.js (SQLite im Browser) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <script>
    // ----- Helfer -----
    const $ = sel => document.querySelector(sel);

    // Format "JJJJ-MM-DD HH:MM:SS" in Europe/Berlin
    function nowBerlin() {
      try {
        const tz = 'Europe/Berlin';
        const d = new Date();
        // Komponenten im Ziel-TZ erzeugen
        const parts = new Intl.DateTimeFormat('de-DE', {
          timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit',
          hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
        }).formatToParts(d).reduce((acc,p)=>{acc[p.type]=p.value; return acc;}, {});
        // de-DE liefert TT.MM.JJJJ — wir wollen JJJJ-MM-DD HH:MM:SS
        const DD = parts.day, MM = parts.month, YYYY = parts.year;
        const HH = parts.hour, MIN = parts.minute, SS = parts.second;
        return `${YYYY}-${MM}-${DD} ${HH}:${MIN}:${SS}`;
      } catch {
        // Fallback: lokale Zeit ohne TZ-Konversion
        const pad = n => String(n).padStart(2,'0');
        const d = new Date();
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      }
    }

    // Zeige "Jetzt" sofort
    function updateNowPreview(){
      $('#nowPreview').value = nowBerlin();
    }
    updateNowPreview();
    setInterval(updateNowPreview, 1000);

    // ----- Schema (CREATE TABLES) -----
    // Hinweis: __rowid__ ist ein spezielles SQLite-RowID-Alias und wird NICHT als Spalte angelegt.
    const schemaSQL = `
CREATE TABLE IF NOT EXISTS android_metadata (
  locale TEXT
);

CREATE TABLE IF NOT EXISTS tblCompany (
  SecutestSerialNumber TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  KeyCode TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  RegistrationDate TEXT NOT NULL, -- declared=DATETIME; datetime-like,
  CustomerNumber TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  Company TEXT NOT NULL, -- declared=VARCHAR2 (50),
  Department TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  Name TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  Street TEXT NOT NULL, -- declared=VARCHAR2 (50),
  PostalCode INTEGER NOT NULL, -- declared=VARCHAR2 (10),
  City TEXT NOT NULL, -- declared=VARCHAR2 (50),
  TelephoneNumber TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  FaxNumber TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  Email TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  Country TEXT NOT NULL, -- declared=VARCHAR2 (20),
  Supplier TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  ArchiveDate TEXT NOT NULL, -- declared=DATETIME; datetime-like,
  ArchiveInterval INTEGER NOT NULL, -- declared=INT,
  Timestamp TEXT NOT NULL, -- declared=DATETIME; datetime-like
);

CREATE TABLE IF NOT EXISTS tblCustomer (
  "CustomerNumber" INTEGER NOT NULL, -- declared=VARCHAR2 (50),
  "Name" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "Contact" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "Street" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "ZIP" INTEGER NOT NULL, -- declared=VARCHAR2 (20),
  "City" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "Country" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "Tel" TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  "Fax" TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  "Email" TEXT NOT NULL, -- declared=VARCHAR2 (100); empty-string,
  "Remark" TEXT NOT NULL, -- declared=VARCHAR2 (255); empty-string,
  "Timestamp" TEXT NOT NULL, -- declared=DATETIME; datetime-like,
  "ArchiveDate" TEXT NOT NULL, -- declared=DATETIME; datetime-like,
  "ArchiveInterval" INTEGER NOT NULL -- declared=INT
);

CREATE TABLE IF NOT EXISTS tblDeviceAbbreviations (
  "DeviceAbbreviation" TEXT NOT NULL, -- declared=VARCHAR2 (10),
  "DeviceDescription" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "Timestamp" TEXT NOT NULL -- declared=DATETIME; datetime-like
);

CREATE TABLE IF NOT EXISTS tblIDNumberCaptions (
  "Name" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "Order" INTEGER NOT NULL, -- declared=INT,
  "NewOrder" TEXT, -- declared=INT,
  "ColumnNo" INTEGER NOT NULL, -- declared=INT,
  "NewCaption" TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  "Hide" INTEGER NOT NULL, -- declared=INT,
  "ProtocolNumber" INTEGER NOT NULL, -- declared=INT,
  "Mandatory" INTEGER NOT NULL, -- declared=INT,
  "Export" INTEGER NOT NULL, -- declared=BIT,
  "TimeStamp" TEXT NOT NULL -- declared=DATETIME; datetime-like
);

CREATE TABLE IF NOT EXISTS tblIDNumbers (
  "ProcedureName" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "CustomerNumber" INTEGER NOT NULL, -- declared=VARCHAR2 (50),
  "IDNumber" INTEGER NOT NULL, -- declared=VARCHAR2 (50),
  "Location" TEXT NOT NULL, -- declared=VARCHAR2 (32); empty-string,
  "DeviceDescription" TEXT NOT NULL, -- declared=VARCHAR2 (64),
  "Manufacturer" TEXT NOT NULL, -- declared=VARCHAR2 (32); empty-string,
  "Type" TEXT NOT NULL, -- declared=VARCHAR2 (32),
  "Class" TEXT NOT NULL, -- declared=VARCHAR2 (32),
  "Standard" TEXT NOT NULL, -- declared=VARCHAR2 (32),
  "SubStandard" TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  "FactoryNumber" TEXT NOT NULL, -- declared=VARCHAR2 (64); empty-string,
  "User1" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "User2" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "User3" INTEGER NOT NULL, -- declared=VARCHAR2 (50),
  "Remark" TEXT NOT NULL, -- declared=VARCHAR2 (100); empty-string,
  "TestInterval" INTEGER NOT NULL, -- declared=INT,
  "ProtocolForm" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "CableLength" TEXT NOT NULL, -- declared=VARCHAR2 (20); empty-string,
  "CableCrossection" TEXT NOT NULL, -- declared=VARCHAR2 (10); empty-string,
  "HeatingPower" TEXT NOT NULL, -- declared=VARCHAR2 (10); empty-string,
  "Power" TEXT NOT NULL, -- declared=VARCHAR2 (10); empty-string,
  "OCVoltage" TEXT NOT NULL, -- declared=VARCHAR2 (6); empty-string,
  "AppliedParts" TEXT NOT NULL, -- declared=VARCHAR2 (32); empty-string,
  "RCDType" TEXT NOT NULL, -- declared=VARCHAR2 (20); empty-string,
  "RCDIDN" TEXT NOT NULL, -- declared=VARCHAR2 (10); empty-string,
  "IsolatedParts" TEXT NOT NULL, -- declared=VARCHAR2 (2); empty-string,
  "PEParts" TEXT NOT NULL, -- declared=VARCHAR2 (3); empty-string,
  "PETest" TEXT NOT NULL, -- declared=VARCHAR2 (23); empty-string,
  "InsulationTest" TEXT NOT NULL, -- declared=VARCHAR2 (3); empty-string,
  "CurrentClamp" TEXT NOT NULL, -- declared=VARCHAR2 (3); empty-string,
  "PRCDS" TEXT NOT NULL, -- declared=VARCHAR2 (3); empty-string,
  "ELV" TEXT NOT NULL, -- declared=VARCHAR2 (10); empty-string,
  "ELVTest" TEXT NOT NULL, -- declared=VARCHAR2 (3); empty-string,
  "SurgeArrestor" TEXT NOT NULL, -- declared=VARCHAR2 (3); empty-string,
  "Wiring" TEXT NOT NULL, -- declared=VARCHAR2 (3); empty-string,
  "Pictures" TEXT NOT NULL, -- declared=VARCHAR2 (255); empty-string,
  "LastTest" TEXT NOT NULL, -- declared=DATETIME; datetime-like,
  "TestResult" TEXT NOT NULL, -- declared=VARCHAR2 (5),
  "NextTest" TEXT NOT NULL, -- declared=DATETIME; datetime-like,
  "Hyperlink" TEXT NOT NULL, -- declared=TEXT; empty-string,
  "Status" INTEGER NOT NULL, -- declared=INT,
  "Remark2" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "TestNumber" INTEGER NOT NULL, -- declared=INT,
  "Timestamp" TEXT NOT NULL -- declared=DATETIME; datetime-like
);

CREATE TABLE IF NOT EXISTS tblMasterProcedureCopy (
  "FunctionNumber" INTEGER NOT NULL, -- declared=INT,
  "FunctionName" TEXT NOT NULL, -- declared=VARCHAR2 (10),
  "Test" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "StatusText" TEXT NOT NULL, -- declared=VARCHAR2 (100),
  "Picture" TEXT, -- declared=VARCHAR2 (50),
  "WorstCase" INTEGER NOT NULL, -- declared=BIT,
  "TestTime" REAL NOT NULL, -- declared=FLOAT,
  "Parameter1" TEXT, -- declared=VARCHAR2 (50),
  "Parameter2" TEXT, -- declared=VARCHAR2 (50),
  "Parameter3" TEXT, -- declared=VARCHAR2 (50),
  "Parameter4" TEXT, -- declared=VARCHAR2 (50),
  "Min" TEXT, -- declared=VARCHAR2 (30),
  "Max" TEXT, -- declared=VARCHAR2 (30),
  "First" TEXT, -- declared=VARCHAR2 (30),
  "Expected" TEXT, -- declared=VARCHAR2 (30),
  "Unit" TEXT, -- declared=VARCHAR2 (10),
  "RangeMin" INTEGER, -- declared=VARCHAR2 (50),
  "RangeMax" TEXT, -- declared=VARCHAR2 (50),
  "TypeParameter1" TEXT, -- declared=VARCHAR2 (10),
  "TypeParameter2" TEXT, -- declared=VARCHAR2 (10),
  "TypeParameter3" TEXT, -- declared=VARCHAR2 (10),
  "TypeParameter4" TEXT, -- declared=VARCHAR2 (10),
  "WorstCaseCondition" TEXT, -- declared=VARCHAR2 (5),
  "Simulation" TEXT, -- declared=VARCHAR2 (50),
  "WebServer" INTEGER NOT NULL -- declared=BIT
);

CREATE TABLE IF NOT EXISTS tblResults (
  "ProcedureName" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "CustomerNumber" INTEGER NOT NULL, -- declared=VARCHAR2 (50),
  "IDNumber" INTEGER NOT NULL, -- declared=VARCHAR2 (50),
  "TestNumber" INTEGER NOT NULL, -- declared=INT,
  "ResultNumber" INTEGER NOT NULL, -- declared=INT,
  "ProcedureStepNumber" TEXT NOT NULL, -- declared=INT; empty-string,
  "FunctionName" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "Picture" TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  "Remark" TEXT NOT NULL, -- declared=VARCHAR2 (128); empty-string,
  "Protocol" INTEGER NOT NULL, -- declared=BIT,
  "WorstCase" TEXT NOT NULL, -- declared=BIT; empty-string,
  "TestTime" REAL NOT NULL, -- declared=FLOAT,
  "Parameter1" TEXT NOT NULL, -- declared=VARCHAR2 (101); empty-string,
  "Parameter2" TEXT NOT NULL, -- declared=VARCHAR2 (101); empty-string,
  "Parameter3" TEXT NOT NULL, -- declared=VARCHAR2 (64); empty-string,
  "Parameter4" TEXT NOT NULL, -- declared=VARCHAR2 (64); empty-string,
  "Min" TEXT NOT NULL, -- declared=VARCHAR2 (30); empty-string,
  "Max" TEXT NOT NULL, -- declared=VARCHAR2 (30); empty-string,
  "First" TEXT NOT NULL, -- declared=VARCHAR2 (30); empty-string,
  "Expected" TEXT NOT NULL, -- declared=VARCHAR2 (30); empty-string,
  "Result" TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  "OK" TEXT NOT NULL -- declared=VARCHAR2 (10)
);

CREATE TABLE IF NOT EXISTS tblResultsHeader (
  "ProcedureName" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "CustomerNumber" INTEGER NOT NULL, -- declared=VARCHAR2 (50),
  "IDNumber" INTEGER NOT NULL, -- declared=VARCHAR2 (50),
  "TestNumber" INTEGER NOT NULL, -- declared=INT,
  "OrderNumber" TEXT NOT NULL, -- declared=VARCHAR2 (50); empty-string,
  "Remark" TEXT NOT NULL, -- declared=TEXT; empty-string,
  "TestDate" TEXT NOT NULL, -- declared=DATETIME; datetime-like,
  "TestResult" TEXT NOT NULL, -- declared=VARCHAR2 (5),
  "TestingPerson" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "Pictures" TEXT NOT NULL, -- declared=VARCHAR2 (255); empty-string,
  "SecutestIDString" TEXT NOT NULL, -- declared=VARCHAR2 (100),
  "SoftwareVersion" TEXT NOT NULL, -- declared=VARCHAR2 (10),
  "SecutestSoftwareVersion" TEXT NOT NULL, -- declared=VARCHAR2 (32),
  "TesterSerialNumber" TEXT NOT NULL, -- declared=VARCHAR2 (50),
  "LineVoltage" TEXT NOT NULL, -- declared=VARCHAR2 (10); empty-string,
  "Protocol" TEXT NOT NULL, -- declared=VARCHAR2 (100); empty-string,
  "Timestamp" TEXT NOT NULL -- declared=DATETIME; datetime-like
);

CREATE TABLE IF NOT EXISTS tblSecutestRegistration (
  "SecutestSerialNumber" TEXT, -- declared=VARCHAR2 (50),
  "KeyCode" TEXT, -- declared=VARCHAR2 (50),
  "RegistrationDate" TEXT, -- declared=DATETIME,
  "CustomerNumber" TEXT, -- declared=VARCHAR2 (50),
  "Company" TEXT, -- declared=VARCHAR2 (50),
  "Department" TEXT, -- declared=VARCHAR2 (50),
  "Name" TEXT, -- declared=VARCHAR2 (50),
  "Street" TEXT, -- declared=VARCHAR2 (50),
  "PostalCode" TEXT, -- declared=VARCHAR2 (10),
  "City" TEXT, -- declared=VARCHAR2 (50),
  "TelephoneNumber" TEXT, -- declared=VARCHAR2 (50),
  "FaxNumber" TEXT, -- declared=VARCHAR2 (50),
  "Email" TEXT, -- declared=VARCHAR2 (50),
  "Country" TEXT, -- declared=VARCHAR2 (20),
  "Supplier" TEXT, -- declared=VARCHAR2 (50),
  "Timestamp" TEXT -- declared=DATETIME
);

CREATE TABLE IF NOT EXISTS tblVisInspectionWeldingHeader (
  "ProcedureName" TEXT, -- declared=VARCHAR2 (50),
  "CustomerNumber" TEXT, -- declared=VARCHAR2 (50),
  "IDNumber" TEXT, -- declared=VARCHAR2 (50),
  "TestNumber" TEXT, -- declared=INT,
  "ResultNumber" TEXT, -- declared=INT,
  "TestDetail1" TEXT, -- declared=BIT,
  "TestResult1" TEXT, -- declared=BIT,
  "TestDetail2" TEXT, -- declared=BIT,
  "TestResult2" TEXT, -- declared=BIT,
  "TestDetail3" TEXT, -- declared=BIT,
  "TestResult3" TEXT, -- declared=BIT,
  "TestDetail4" TEXT, -- declared=BIT,
  "TestResult4" TEXT, -- declared=BIT,
  "TestDetail5" TEXT, -- declared=BIT,
  "TestResult5" TEXT, -- declared=BIT,
  "TestDetail6" TEXT, -- declared=BIT,
  "TestResult6" TEXT, -- declared=BIT,
  "TestDetail7" TEXT, -- declared=BIT,
  "TestResult7" TEXT, -- declared=BIT,
  "TestDetail8" TEXT, -- declared=BIT,
  "TestResult8" TEXT -- declared=BIT
);

CREATE TABLE IF NOT EXISTS tblVisInspectionWeldingResults (
  "ProcedureName" TEXT, -- declared=VARCHAR2 (50),
  "CustomerNumber" TEXT, -- declared=VARCHAR2 (50),
  "IDNumber" TEXT, -- declared=VARCHAR2 (50),
  "TestNumber" TEXT, -- declared=INT,
  "ResultNumber" TEXT, -- declared=INT,
  "VisTestNumber" TEXT, -- declared=INT,
  "InspectionNumber" TEXT, -- declared=INT,
  "InspectionResult" TEXT -- declared=BIT
);
`.trim();

    $('#schemaPreview').textContent = schemaSQL;

    // ----- DB bauen & exportieren -----
    let SQL; // sql.js Modul

    (async function initSql(){
      SQL = await initSqlJs({
        locateFile: file => 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/' + file
      });
    })();

    function showAlert(html, type='info'){
      $('#alertBox').innerHTML = `<div class="alert alert-${type} mb-0" role="alert">${html}</div>`;
    }

    async function buildAndExport(){
      if(!SQL){ showAlert('SQL-Engine lädt noch. Bitte erneut versuchen …','warning'); return; }

      const now = nowBerlin(); // "Jetzt"
      const db = new SQL.Database();

      try{
        // Schema ausführen
        db.run('BEGIN;');
        db.run(schemaSQL);

        // Optionale Standardzeile für android_metadata (falls gewünscht – nicht gefordert):
        // db.run(`INSERT INTO android_metadata(locale) VALUES ('de_DE');`);

        // tblCompany – Zeile 1
        {
          const sql = `
            INSERT INTO tblCompany (
              SecutestSerialNumber, KeyCode1, RegistrationDate1, CustomerNumber, Company, Department, Name, Street, PostalCode, City,
              TelephoneNumber, FaxNumber, Email, Country, Supplier, ArchiveDate, ArchiveInterval, Timestamp
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
          `;
          const params = [
            null, // SecutestSerialNumber
            null, // KeyCode1
            '2021-09-13 14:46:04', // RegistrationDate1
            null, // CustomerNumber
            'E+Service+Check GmbH', // Company
            null, // Department
            null, // Name
            'Große Ziegelohstraße 2', // Street
            '06636', // PostalCode
            'Laucha (Unstrut)', // City
            null, // TelephoneNumber
            null, // FaxNumber
            null, // Email
            'DE - Deutschland', // Country
            null, // Supplier
            '2021-09-13 14:46:04', // ArchiveDate
            12,   // ArchiveInterval
            '2021-09-13 12:46:04'  // Timestamp
          ];
          const stmt = db.prepare(sql);
          stmt.bind(params); stmt.step(); stmt.free();
          // RowID wird automatisch 1 (erste Zeile)
        }

        // tblCustomer – Zeile 1 (mit "Jetzt")
        {
          const sql = `
            INSERT INTO tblCustomer (
              CustomerNumber1, Name, Contact, Street, ZIP, City, Country, Tel, Fax, Email, Remark, Timestamp, ArchiveDate, ArchiveInterval
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
          `;
          const params = [
            '666',
            'Max Muster Corp',
            'Max Muster',
            'Musterstraße 3',
            '666',
            'Musterstadt',
            'DE - Deutschland',
            null, null, null, // Tel, Fax, Email
            null,             // Remark
            now,              // Timestamp (Jetzt)
            now,              // ArchiveDate (Jetzt)
            12                // ArchiveInterval
          ];
          const stmt = db.prepare(sql);
          stmt.bind(params); stmt.step(); stmt.free();
        }

        db.run('COMMIT;');

        // Export
        const binaryArray = db.export(); // Uint8Array
        const blob = new Blob([binaryArray], { type: 'application/octet-stream' });

        // Download-Link aktivieren
        const url = URL.createObjectURL(blob);
        const ts = now.replace(/[: ]/g,'-'); // für Dateinamen
        const filename = `export_${ts}.sqlite`;
        const a = $('#downloadLink');
        a.href = url;
        a.download = filename;
        a.classList.remove('disabled');

        showAlert(`Fertig! <strong>${filename}</strong> ist bereit zum Download.`, 'success');
      } catch(e){
        try{ db.run('ROLLBACK;'); }catch(_){}
        console.error(e);
        showAlert(`Fehler beim Erstellen: <code class="mono">${(e && e.message) ? e.message : e}</code>`, 'danger');
      } finally {
        // db.close() nicht nötig solange Blob/URL lebt; wir lassen offen bis Download.
      }
    }

    $('#btnBuild').addEventListener('click', buildAndExport);
  </script>
</body>
</html>
