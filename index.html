<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SQLite-Exporter – V1.23 </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f8fafc}
    .card{border-radius:1rem}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .small-mono{font-size:.9rem}
    .kv dt{width:11rem}
    .kv dd{margin-left:12.5rem}
  </style>
</head>
<body>
  <main class="container py-4">
    <div class="row g-3">
      <div class="col-12 col-lg-7">
        <div class="card shadow-sm">
          <div class="card-body">
            <h1 class="h4 mb-3">SQLite3 Generator – V1.23</h1>
            <div class="mb-3">
              <label class="form-label">PDF mit Kundendaten</label>
              <input id="pdfInput" type="file" class="form-control" accept="application/pdf">
            </div>
            <div class="mb-3" id="pdfPreviewWrap" style="display:none;">
              <div class="alert alert-info mb-2">
                <strong>Erkannte PDF-Daten</strong>
              </div>
              <dl class="kv small-mono">
                <dt>CustomerNumber</dt><dd id="pvCustomerNumber">–</dd>
                <dt>Name</dt><dd id="pvName">–</dd>
                <dt>Contact</dt><dd id="pvContact">–</dd>
                <dt>Telefon</dt><dd id="pvTel">–</dd>
                <dt>Street</dt><dd id="pvStreet">–</dd>
                <dt>ZIP</dt><dd id="pvZIP">–</dd>
                <dt>City</dt><dd id="pvCity">–</dd>
                <dt>Prüfobjekt-Adresse</dt><dd id="pvPO">–</dd>
              </dl>
            </div>
            <div class="mb-3">
              <label class="form-label">„Jetzt“-Zeit (Europa/Berlin)</label>
              <input id="nowPreview" class="form-control mono" readonly>
            </div>
            <div class="d-grid d-sm-flex gap-2">
              <button id="btnBuild" class="btn btn-primary btn-lg">SQLite3 exportieren</button>
              <a id="downloadLink" class="btn btn-outline-secondary btn-lg disabled" download>Download ist bereit</a>
            </div>
            <div id="alertBox" class="mt-3"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    const $ = sel => document.querySelector(sel);
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    const exclusionList = [
      /E\+?\s*Serv/i,
      /Große?\s+Ziegelohstr/i,
      /06636\s+Laucha/i,
      /Unstrut/i,
      /Mitglied/i,
      /Zertifiziert/i,
      /Unterwegs/i,
      /Projektleiter/i,
      /Arbeitsauftrag/i,
      /Telefon/i,
      /m\.kain@/i
    ];

    function isExcludedName(txt){
      if(!txt) return true;
      if(txt.length < 3) return true;
      return exclusionList.some(rx => rx.test(txt));
    }

    function nowBerlin(){
      try{
        const d=new Date(), tz='Europe/Berlin';
        const p=new Intl.DateTimeFormat('de-DE',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})
          .formatToParts(d).reduce((a,p)=>{a[p.type]=p.value;return a;},{});
        return `${p.year}-${p.month}-${p.day} ${p.hour}:${p.minute}:${p.second}`;
      }catch{
        const pad=n=>String(n).padStart(2,'0'); const d=new Date();
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      }
    }
    function updateNow(){ $('#nowPreview').value = nowBerlin(); } updateNow(); setInterval(updateNow,1000);

    async function pdfToLines(file){
      const ab = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data: ab}).promise;
      const all=[];
      for(let p=1;p<=pdf.numPages;p++){
        const page = await pdf.getPage(p);
        const tc = await page.getTextContent();
        const linesMap=new Map();
        tc.items.forEach(it=>{
          const text=it.str||''; const tr=it.transform||[1,0,0,1,0,0];
          const y=tr[5]||0,x=tr[4]||0;
          if(!linesMap.has(y)) linesMap.set(y,[]);
          linesMap.get(y).push({x,text});
        });
        const ys=[...linesMap.keys()].sort((a,b)=>a-b);
        ys.forEach(y=>{
          const txt=linesMap.get(y).sort((a,b)=>a.x-b.x).map(i=>i.text).join(' ').replace(/\s+/g,' ').trim();
          if(txt) all.push({text:txt,y:Math.round(y)});
        });
      }
      const seen=new Set(), out=[];
      for(const o of all){ if(seen.has(o.text)) continue; seen.add(o.text); out.push(o); }
      return out;
    }

    $('#pdfInput').addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const parsed={};
      try{
        const objs=await pdfToLines(f);
        const lines=objs.map(o=>o.text);
        const notVendor=(i)=>i>=0 && i<lines.length && !/E\+?Serv/i.test(lines[i]);

        // Kundennummer
        for(const l of lines){
          const m=l.match(/Kunden-?Nr\.?\s*:\s*(\d+)/i);
          if(m){ parsed.CustomerNumber=m[1]; break; }
        }

        // Ansprechpartner
        for(const l of lines){
          const m=l.match(/Ansprechpartner\s*:\s*(.+)$/i);
          if(m){
            const raw=m[1];
            const [n,t]=raw.split(/\bTel\b\s*:?\s*/i);
            parsed.Contact=n.trim().replace(/[,\s]+$/,'');
            if(t) parsed.Tel=t.trim();
          }
        }

        // Prüfobjekt-Adresse
        for(const l of lines){
          const m=l.match(/Adresse\s*:\s*(.+)$/i);
          if(m){ parsed.PO=m[1].trim(); break; }
        }

        // Straße
        const streetRe=/[A-Za-zÄÖÜäöüß\.\- ]+\s+\d+[a-zA-Z]?$/;
        let streetIdx=-1;
        for(let i=0;i<lines.length;i++){ if(streetRe.test(lines[i])){ streetIdx=i; break; } }
        if(streetIdx>=0){
          parsed.Street=lines[streetIdx];
          const streetY=objs[streetIdx].y;
          let bestIdx=-1,bestDy=Infinity;
          for(let j=0;j<objs.length;j++){
            const dy=objs[j].y-streetY;
            if(dy>0 && dy<bestDy){
              const txt=objs[j].text.trim();
              if(!isExcludedName(txt)&&!txt.includes(',')){bestDy=dy;bestIdx=j;}
            }
          }
          // Fallback
          if(bestIdx===-1){
            let nearIdx=-1,minDist=Infinity;
            for(const o of objs){
              const dist=Math.abs(o.y-streetY);
              if(o.y>streetY && dist<minDist && !isExcludedName(o.text)){minDist=dist;nearIdx=objs.indexOf(o);}
            }
            if(nearIdx!==-1) bestIdx=nearIdx;
          }
          if(bestIdx!==-1) parsed.Name=objs[bestIdx].text.trim();
          // ZIP/City
          for(const l of lines){
            const m=l.match(/\b(\d{5})\b\s+([A-ZÄÖÜ][A-Za-zÄÖÜäöüß\-\(\) ]+)/);
            if(m){parsed.ZIP=m[1];parsed.City=m[2];break;}
          }
        }

        $('#pvCustomerNumber').textContent=parsed.CustomerNumber||'–';
        $('#pvName').textContent=parsed.Name||'–';
        $('#pvContact').textContent=parsed.Contact||'–';
        $('#pvTel').textContent=parsed.Tel||'–';
        $('#pvStreet').textContent=parsed.Street||'–';
        $('#pvZIP').textContent=parsed.ZIP||'–';
        $('#pvCity').textContent=parsed.City||'–';
        $('#pvPO').textContent=parsed.PO||'–';
        $('#pdfPreviewWrap').style.display='block';
      }catch(err){console.error(err);alert('Fehler beim PDF-Lesen.');}
    });
  </script>
</body>
</html>
